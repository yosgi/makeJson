<!DOCTYPE HTML>
<html lang="zh-cn">
<head>
    <meta charset="UTF-8">
<style>

.flist{
	padding:10px 0;
}

.flist table{
	width:500px;
}
.flist table tr th{
	padding:2px 10px;
}

.flist table tr td{
	padding:2px 10px;
	border:1px solid #ddd;
}

.delfilter {
	border:1px solid #ccc;
	display:block;
	width:80px;
	text-align:center;
	background-color: #ccc;
	font-size:13px;
	font-weight:bold;
	text-decoration: none;
}

.fgroup{
	padding:5px 0px;
	margin-bottom:5px;
}

.pdiv textarea{
	margin-top:5px;
}



</style>
</head>
<body>


<div>
<h2>过滤条件</h2>
<div class="flist">
</div>
<hr />
<div class="fdiv">
<form id="fform">
<div class="fgroup">
<label>IP Range:</label>
<input type="text" name="ip1" placeHolder="192.168.0.1" value="192.168.0.1">
~ <input type="text" name="ip2" placeHolder="192.168.0.255" value="192.168.0.255">
</div>
<div class="fgroup">
<label>User Agent:</label>
<input type="text" name="ua" placeHolder="MS" value="MS">
</div>
<input type="button" id="addfilter" value="增加">
</form>
</div>
</div>
<hr/>
<h2>导出数据</h2>
<div class="pdiv">
<form id="pform">
<div class="fgroup">
<label>开始日期：</label>
<input type="text" name="date" placeHolder="20151212" value=""> 
</div>
<div class="fgroup">
<label>天数：</label>
<input type="text" name="days" placeHolder="1" value="1" style="width:30px">
</div>
<div class="fgroup">
<label>特征url:</label> <br />
<textarea cols="50" rows="10" name="urls"></textarea>
</div>
<input type="button" id="export" value="导出">
</form>
</div>


<script type="text/javascript" src="http://www.openhw.org/assets/js/jquery.min.js"></script>


<script>

$(function(){

	function renderfilter(data){
		if(data.code != 0){
  			alert(data.message)
  		}
  		var str = '<table><tr><th width="25%">IP from</th><th width="25%">IP To</th><th width="30%">UserAgent</th><th width="20%"></th></tr>';
  		$.each(data.result,function(i,obj){
  			str+='<tr><td>' + obj.ip1+'</td><td>'+obj.ip2+'</td><td>'+obj.ua+'</td><td><a href="#" class="delfilter" data-id="'+i+'">删除</a></td></tr>';
  		})
  		str += '</table>';
  		$('.flist').html(str);

  		$('.delfilter').on('click',function(){
    	    var id = $(this).attr('data-id');
			$.ajax({
				  type: "POST",
				  url: "ajax.php",
				  data: 'id='+id+ '&m=delfilter',
				  dataType: "JSON",
				  success:function(data){
				  		renderfilter(data);
				  }
			})
		})
	}

	$.ajax({
		  type: "POST",
		  url: "ajax.php",
		  data: 'm=getfilters',
		  dataType: "JSON",
		  success:function(data){
		  		renderfilter(data);
		  }
	})

	$('#addfilter').on('click',function(){
			$.ajax({
				  type: "POST",
				  url: "ajax.php",
				  data: $('#fform').serialize() + '&m=addfilter',
				  dataType: "JSON",
				  success:function(data){
				  		renderfilter(data);
				  }
			})
	})

	$('#export').on('click',function(){
			$.ajax({
				  type: "POST",
				  url: "ajax.php",
				  data: $('#pform').serialize() + '&m=export',
				  dataType: "JSON",
				  success:function(data){
				  		if(data.code != 0){
				  			alert(data.message);
				  		}
				  		if($('#downloadiframe').size() > 0){
			               $('#downloadiframe').attr('src',data.result+'?'+Math.random());
			            }else{
			              $("body").append('<iframe id="downloadiframe" src="'+data.result+'?'+Math.random()+'" style="display: none">');
			            }
				  }
			})

	})

    
})




</script>
</body>
</html>